{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">ä½™é¢æ“ä½œ</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">æ‰§è¡Œä½™é¢æ“ä½œ</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="">
                    {{ form.hidden_tag() }}
                    
                    <div class="form-group">
                        {{ form.username.label(class="form-control-label") }}
                        {{ form.username(class="form-control") }}
                        <small class="form-text text-muted">è¾“å…¥è¦æ“ä½œçš„ç”¨æˆ·å</small>
                        {% for error in form.username.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.operation_type.label(class="form-control-label") }}
                        {{ form.operation_type(class="form-control") }}
                        {% for error in form.operation_type.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div id="targetUserGroup" class="form-group d-none">
                        {{ form.target_user.label(class="form-control-label") }}
                        {{ form.target_user(class="form-control") }}
                        <small class="form-text text-muted">ä»…è½¬è´¦æ“ä½œéœ€è¦å¡«å†™ç›®æ ‡ç”¨æˆ·å</small>
                        {% for error in form.target_user.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.amount.label(class="form-control-label") }}
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">ğŸ’°</span>
                            </div>
                            {{ form.amount(class="form-control") }}
                            <div class="input-group-append">
                                <span class="input-group-text">å…ƒ</span>
                            </div>
                        </div>
                        {% for error in form.amount.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.reason.label(class="form-control-label") }}
                        {{ form.reason(class="form-control", rows=3) }}
                        <small class="form-text text-muted">è¯·è¯¦ç»†æè¿°æ“ä½œåŸå› ï¼Œä»¥ä¾¿è®°å½•å’Œå®¡è®¡</small>
                        {% for error in form.reason.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" data-toggle="modal" data-target="#confirmModal">æäº¤æ“ä½œ</button>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary ml-2">å–æ¶ˆ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">æ“ä½œè¯´æ˜</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>å……å€¼</strong>ï¼šå¢åŠ ç”¨æˆ·è´¦æˆ·ä½™é¢</li>
                    <li class="list-group-item"><strong>æ‰£æ¬¾</strong>ï¼šå‡å°‘ç”¨æˆ·è´¦æˆ·ä½™é¢</li>
                    <li class="list-group-item"><strong>è½¬è´¦</strong>ï¼šä»ä¸€ä¸ªç”¨æˆ·è´¦æˆ·å‘å¦ä¸€ä¸ªç”¨æˆ·è´¦æˆ·è½¬ç§»ä½™é¢</li>
                    <li class="list-group-item text-danger"><strong>æ³¨æ„</strong>ï¼šæ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•åˆ°ç³»ç»Ÿæ—¥å¿—ä¸­ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤æ“ä½œæ¨¡æ€æ¡† -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">ç¡®è®¤æ“ä½œ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>æ‚¨å³å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
                <ul id="operationDetails">
                    <li><strong>ç”¨æˆ·ï¼š</strong> <span id="confirmUsername"></span></li>
                    <li><strong>æ“ä½œç±»å‹ï¼š</strong> <span id="confirmOperationType"></span></li>
                    <li id="confirmTargetUser"><strong>ç›®æ ‡ç”¨æˆ·ï¼š</strong> <span></span></li>
                    <li><strong>é‡‘é¢ï¼š</strong> <span id="confirmAmount"></span> å…ƒ</li>
                    <li><strong>åŸå› ï¼š</strong> <span id="confirmReason"></span></li>
                </ul>
                <p class="text-danger mt-3">æ­¤æ“ä½œå°†ç›´æ¥å½±å“ç”¨æˆ·è´¦æˆ·ä½™é¢ï¼Œç¡®è®¤æ‰§è¡Œï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">ç¡®è®¤æ‰§è¡Œ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // æ“ä½œç±»å‹å˜åŒ–æ—¶æ˜¾ç¤º/éšè—ç›®æ ‡ç”¨æˆ·å­—æ®µ
    $('#operation_type').change(function() {
        if ($(this).val() === 'transfer') {
            $('#targetUserGroup').removeClass('d-none');
            $('#targetUserGroup').addClass('d-block');
            $('#target_user').prop('required', true);
        } else {
            $('#targetUserGroup').removeClass('d-block');
            $('#targetUserGroup').addClass('d-none');
            $('#target_user').prop('required', false);
        }
    });
    
    // æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶å¡«å……æ•°æ®
    $('#confirmModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        
        // è·å–è¡¨å•æ•°æ®
        var username = $('#username').val();
        var operationType = $('#operation_type option:selected').text();
        var amount = $('#amount').val();
        var reason = $('#reason').val();
        var targetUser = $('#target_user').val();
        
        // å¡«å……æ¨¡æ€æ¡†æ•°æ®
        modal.find('#confirmUsername').text(username);
        modal.find('#confirmOperationType').text(operationType);
        modal.find('#confirmAmount').text(amount);
        modal.find('#confirmReason').text(reason);
        
        // æ˜¾ç¤º/éšè—ç›®æ ‡ç”¨æˆ·
        if (operationType === 'è½¬è´¦' && targetUser) {
            modal.find('#confirmTargetUser').show();
            modal.find('#confirmTargetUser span').text(targetUser);
        } else {
            modal.find('#confirmTargetUser').hide();
        }
    });
    
    // ç¡®è®¤æäº¤è¡¨å•
        $('#confirmSubmit').click(function() {
            $('#confirmModal').modal('hide');
            // æ·»åŠ çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ¨¡æ€æ¡†å…³é—­åå†æäº¤
            setTimeout(function() {
                $('form').submit();
            }, 500);
        });
});
</script>
{% endblock %}